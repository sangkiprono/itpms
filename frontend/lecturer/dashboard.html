<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lecturer Dashboard - Teaching Practice Management System</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="../assets/css/style.css">
</head>
<body>
    <!-- Sidebar Overlay for Mobile -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>
    
    <div class="d-flex">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="navbar-brand d-flex align-items-center justify-content-center">
                <i class="bi bi-book me-2"></i>
                <span>TPMS Lecturer</span>
            </div>
            
            <div class="sidebar-heading">
                Main
            </div>
            
            <ul class="nav flex-column">
                <li class="nav-item">
                    <a class="nav-link active" href="dashboard.html">
                        <i class="bi bi-speedometer2"></i> Dashboard
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="students.html">
                        <i class="bi bi-people"></i> My Students
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="evaluations.html">
                        <i class="bi bi-clipboard-check"></i> Evaluations
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="reports.html">
                        <i class="bi bi-file-earmark-text"></i> Student Reports
                    </a>
                </li>
            </ul>
            
            <div class="sidebar-heading">
                Settings
            </div>
            
            <ul class="nav flex-column">
                <li class="nav-item">
                    <a class="nav-link" href="profile.html">
                        <i class="bi bi-person"></i> My Profile
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" id="logoutBtn">
                        <i class="bi bi-box-arrow-right"></i> Logout
                    </a>
                </li>
            </ul>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <!-- Top Navigation -->
            <nav class="navbar navbar-expand-lg navbar-light top-navbar">
                <div class="container-fluid">
                    <button class="btn btn-sm btn-outline-secondary d-lg-none me-3" type="button" id="sidebarToggle" title="Toggle Sidebar">
                        <i class="bi bi-list"></i>
                    </button>
                    
                    <h4 class="mb-0">Lecturer Dashboard</h4>
                    
                    <div class="ms-auto d-flex align-items-center">
                        <div class="dropdown">
                            <a class="dropdown-toggle text-decoration-none text-dark d-flex align-items-center" href="#" role="button" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                <span class="me-2" id="userName">Lecturer Name</span>
                                <div class="user-dropdown">
                                    <img src="../assets/images/avatar-placeholder.jpg" alt="User" id="userImage">
                                </div>
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                                <li><a class="dropdown-item" href="profile.html"><i class="bi bi-person me-2"></i> Profile</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="#" id="logoutDropdownBtn"><i class="bi bi-box-arrow-right me-2"></i> Logout</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </nav>
            
            <!-- Alert Container -->
            <div id="alertContainer"></div>
            
            <!-- Dashboard Content -->
            <div class="container-fluid">
                <!-- Stats Cards -->
                <div class="row g-3">
                    <div class="col-md-4">
                        <div class="dashboard-card bg-gradient-primary">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="card-title text-white">Assigned Students</div>
                                    <div class="card-value text-white" id="assignedStudentsCount">0</div>
                                </div>
                                <div class="card-icon">
                                    <i class="bi bi-people-fill text-white-50"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="dashboard-card bg-gradient-info">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="card-title text-white">Pending Evaluations</div>
                                    <div class="card-value text-white" id="pendingEvaluationsCount">0</div>
                                </div>
                                <div class="card-icon">
                                    <i class="bi bi-clipboard-check text-white-50"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="dashboard-card bg-gradient-success">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="card-title text-white">New Reports</div>
                                    <div class="card-value text-white" id="newReportsCount">0</div>
                                </div>
                                <div class="card-icon">
                                    <i class="bi bi-file-earmark-text text-white-50"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Recent Activities and Upcoming Visits -->
                <div class="row mt-4">
                    <div class="col-md-6">
                        <div class="dashboard-card">
                            <h5 class="mb-3">Recent Activities</h5>
                            <div class="list-group" id="recentActivitiesList">
                                <div class="text-center py-3">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="dashboard-card">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="mb-0">Upcoming Visits</h5>
                                <a href="evaluations.html" class="btn btn-sm btn-primary">Schedule New</a>
                            </div>
                            <div id="upcomingVisitsContent">
                                <div class="text-center py-3">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Recent Evaluations -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="dashboard-card">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="mb-0">Recent Evaluations</h5>
                                <a href="evaluations.html" class="btn btn-sm btn-primary">View All</a>
                            </div>
                            
                            <div class="table-responsive">
                                <table class="table table-hover data-table" id="recentEvaluationsTable">
                                    <thead>
                                        <tr>
                                            <th>Student</th>
                                            <th>Visit Date</th>
                                            <th>Teaching Skills</th>
                                            <th>Classroom Management</th>
                                            <th>Preparation</th>
                                            <th>Professionalism</th>
                                            <th>Overall Grade</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Dynamic content here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- My Students -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="dashboard-card">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="mb-0">My Students</h5>
                                <a href="students.html" class="btn btn-sm btn-primary">View All</a>
                            </div>
                            
                            <div class="table-responsive">
                                <table class="table table-hover data-table" id="myStudentsTable">
                                    <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th>Email</th>
                                            <th>School</th>
                                            <th>Reports</th>
                                            <th>Last Evaluation</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Dynamic content here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../assets/js/main.js"></script>
    <script src="../assets/js/lecturer.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Fetch dashboard data
            fetchDashboardData();
            
            // Fetch recent evaluations
            fetchRecentEvaluations();
            
            // Fetch my students
            fetchMyStudents();
            
            // Fetch upcoming visits
            fetchUpcomingVisits();
            
            // Toggle sidebar on mobile
            const sidebarToggle = document.getElementById('sidebarToggle');
            if (sidebarToggle) {
                sidebarToggle.addEventListener('click', function() {
                    document.querySelector('.sidebar').classList.toggle('d-none');
                });
            }
            
            // Ensure logout button in dropdown works
            const logoutDropdownBtn = document.getElementById('logoutDropdownBtn');
            if (logoutDropdownBtn) {
                logoutDropdownBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    logout();
                });
            }
        });
        
        /**
         * Fetch dashboard data from API
         */
        function fetchDashboardData() {
            apiCall('/lecturer/dashboard')
                .then(data => {
                    // Update stats cards
                    document.getElementById('assignedStudentsCount').textContent = data.student_count || 0;
                    document.getElementById('pendingEvaluationsCount').textContent = '0'; // Placeholder
                    document.getElementById('newReportsCount').textContent = data.recent_reports.length || 0;
                    
                    // Update recent activities
                    updateRecentActivities(data.recent_evaluations, data.recent_reports);
                })
                .catch(error => {
                    console.error('Error fetching dashboard data:', error);
                    showAlert('Failed to load dashboard data. Please try again later.', 'danger');
                });
        }
        
        /**
         * Update recent activities list
         */
        function updateRecentActivities(evaluations, reports) {
            const activitiesList = document.getElementById('recentActivitiesList');
            let activities = [];
            
            // Add evaluations
            if (evaluations && evaluations.length) {
                evaluations.forEach(evaluation => {
                    activities.push({
                        type: 'evaluation',
                        date: new Date(evaluation.submission_date),
                        title: `Evaluation submitted`,
                        description: `You submitted an evaluation for ${evaluation.student ? evaluation.student.first_name + ' ' + evaluation.student.last_name : 'a student'}.`,
                        link: `evaluations.html?id=${evaluation.id}`
                    });
                });
            }
            
            // Add reports
            if (reports && reports.length) {
                reports.forEach(report => {
                    activities.push({
                        type: 'report',
                        date: new Date(report.submission_date),
                        title: `New report received`,
                        description: `A student submitted a ${report.report_type} report: "${report.title}".`,
                        link: `reports.html?id=${report.id}`
                    });
                });
            }
            
            // Sort by date (newest first)
            activities.sort((a, b) => b.date - a.date);
            
            // Limit to 5 items
            activities = activities.slice(0, 5);
            
            // Update the UI
            if (activities.length) {
                let html = '';
                activities.forEach(activity => {
                    html += `
                        <a href="${activity.link}" class="list-group-item list-group-item-action">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">${activity.title}</h6>
                                <small>${formatDate(activity.date)}</small>
                            </div>
                            <p class="mb-1">${activity.description}</p>
                        </a>
                    `;
                });
                activitiesList.innerHTML = html;
            } else {
                activitiesList.innerHTML = '<p class="text-center py-3">No recent activities found.</p>';
            }
        }
        
        /**
         * Fetch recent evaluations
         */
        function fetchRecentEvaluations() {
            apiCall('/lecturer/evaluations?limit=5')
                .then(data => {
                    const evaluations = data.evaluations || [];
                    
                    // Define columns for the table
                    const columns = [
                        { 
                            title: 'Student',
                            render: eval => eval.student ? `${eval.student.first_name} ${eval.student.last_name}` : 'Unknown'
                        },
                        {
                            title: 'Visit Date',
                            render: eval => formatDate(eval.visit_date)
                        },
                        {
                            title: 'Teaching Skills',
                            render: eval => `<span class="badge bg-${getRatingBadgeColor(eval.teaching_skills)}">${eval.teaching_skills}/10</span>`
                        },
                        {
                            title: 'Classroom Management',
                            render: eval => `<span class="badge bg-${getRatingBadgeColor(eval.classroom_management)}">${eval.classroom_management}/10</span>`
                        },
                        {
                            title: 'Preparation',
                            render: eval => `<span class="badge bg-${getRatingBadgeColor(eval.lesson_preparation)}">${eval.lesson_preparation}/10</span>`
                        },
                        {
                            title: 'Professionalism',
                            render: eval => `<span class="badge bg-${getRatingBadgeColor(eval.professionalism)}">${eval.professionalism}/10</span>`
                        },
                        {
                            title: 'Overall Grade',
                            render: eval => `<span class="badge bg-${getGradeBadgeColor(eval.overall_grade)}">${eval.overall_grade}</span>`
                        },
                        {
                            title: 'Actions',
                            render: eval => `
                                <div class="action-buttons">
                                    <a href="view-evaluation.html?id=${eval.id}" class="btn btn-sm btn-info">
                                        <i class="bi bi-eye"></i>
                                    </a>
                                    <a href="edit-evaluation.html?id=${eval.id}" class="btn btn-sm btn-primary">
                                        <i class="bi bi-pencil"></i>
                                    </a>
                                </div>
                            `
                        }
                    ];
                    
                    // Create the table
                    createDataTable(evaluations, columns, 'recentEvaluationsTable');
                })
                .catch(error => {
                    console.error('Error fetching recent evaluations:', error);
                    document.querySelector('#recentEvaluationsTable tbody').innerHTML = `
                        <tr>
                            <td colspan="8" class="text-center">Failed to load evaluation data. Please try again later.</td>
                        </tr>
                    `;
                });
        }
        
        /**
         * Fetch my students
         */
        function fetchMyStudents() {
            apiCall('/lecturer/students?limit=5')
                .then(data => {
                    const students = data.students || [];
                    
                    // Define columns for the table
                    const columns = [
                        { 
                            title: 'Name',
                            render: student => `${student.first_name} ${student.last_name}`
                        },
                        {
                            title: 'Email',
                            property: 'email'
                        },
                        {
                            title: 'School',
                            render: student => student.assigned_schools && student.assigned_schools.length 
                                ? student.assigned_schools[0].name 
                                : 'Not assigned'
                        },
                        {
                            title: 'Reports',
                            render: student => student.reports ? student.reports.length : 0
                        },
                        {
                            title: 'Last Evaluation',
                            render: student => student.last_evaluation 
                                ? formatDate(student.last_evaluation.submission_date) 
                                : 'None'
                        },
                        {
                            title: 'Actions',
                            render: student => `
                                <div class="action-buttons">
                                    <a href="student-detail.html?id=${student.id}" class="btn btn-sm btn-info">
                                        <i class="bi bi-eye"></i>
                                    </a>
                                    <a href="new-evaluation.html?student_id=${student.id}" class="btn btn-sm btn-primary">
                                        <i class="bi bi-clipboard-plus"></i> Evaluate
                                    </a>
                                </div>
                            `
                        }
                    ];
                    
                    // Create the table
                    createDataTable(students, columns, 'myStudentsTable');
                })
                .catch(error => {
                    console.error('Error fetching students:', error);
                    document.querySelector('#myStudentsTable tbody').innerHTML = `
                        <tr>
                            <td colspan="6" class="text-center">Failed to load student data. Please try again later.</td>
                        </tr>
                    `;
                });
        }
        
        /**
         * Fetch upcoming visits
         */
        function fetchUpcomingVisits() {
            // This is a placeholder for now - would need to implement scheduling functionality
            const upcomingVisitsContent = document.getElementById('upcomingVisitsContent');
            upcomingVisitsContent.innerHTML = `
                <div class="list-group">
                    <div class="list-group-item">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">Visit to Jefferson High School</h6>
                            <small class="text-primary">Tomorrow, 9:00 AM</small>
                        </div>
                        <p class="mb-1">Evaluating: John Smith, Mary Johnson</p>
                    </div>
                    <div class="list-group-item">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">Visit to Central Elementary</h6>
                            <small class="text-primary">Apr 2, 2025, 1:30 PM</small>
                        </div>
                        <p class="mb-1">Evaluating: Robert Davis</p>
                    </div>
                    <div class="list-group-item">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">Visit to Westside Middle School</h6>
                            <small class="text-primary">Apr 8, 2025, 10:15 AM</small>
                        </div>
                        <p class="mb-1">Evaluating: Sarah Williams, James Brown</p>
                    </div>
                </div>
            `;
        }
        
        /**
         * Get badge color based on rating (1-10)
         */
        function getRatingBadgeColor(rating) {
            if (rating >= 9) return 'success';
            if (rating >= 7) return 'info';
            if (rating >= 5) return 'warning';
            return 'danger';
        }
        
        /**
         * Get badge color based on grade
         */
        function getGradeBadgeColor(grade) {
            if (['A+', 'A', 'A-'].includes(grade)) return 'success';
            if (['B+', 'B', 'B-'].includes(grade)) return 'info';
            if (['C+', 'C', 'C-'].includes(grade)) return 'warning';
            return 'danger';
        }
        
        // Sidebar toggle for mobile
        const sidebarToggle = document.getElementById('sidebarToggle');
        const sidebar = document.querySelector('.sidebar');
        const sidebarOverlay = document.getElementById('sidebarOverlay');
        
        if (sidebarToggle) {
            sidebarToggle.addEventListener('click', function() {
                sidebar.classList.toggle('active');
                sidebarOverlay.classList.toggle('active');
            });
        }
        
        if (sidebarOverlay) {
            sidebarOverlay.addEventListener('click', function() {
                sidebar.classList.remove('active');
                sidebarOverlay.classList.remove('active');
            });
        }
        
        // Logout functionality
        const logoutBtn = document.getElementById('logoutBtn');
        const logoutDropdownBtn = document.getElementById('logoutDropdownBtn');
        
        if (logoutBtn) {
            logoutBtn.addEventListener('click', function(e) {
                e.preventDefault();
                localStorage.clear();
                window.location.href = '../login.html';
            });
        }
        
        if (logoutDropdownBtn) {
            logoutDropdownBtn.addEventListener('click', function(e) {
                e.preventDefault();
                localStorage.clear();
                window.location.href = '../login.html';
            });
        }
    </script>
</body>
</html>