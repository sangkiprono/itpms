<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Schools - Teaching Practice Management System</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="../assets/css/style.css">
</head>
<body>
    <div class="d-flex">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="navbar-brand d-flex align-items-center justify-content-center">
                <i class="bi bi-book me-2"></i>
                <span>TPMS Admin</span>
            </div>
            
            <div class="sidebar-heading">
                Main
            </div>
            
            <ul class="nav flex-column">
                <li class="nav-item">
                    <a class="nav-link" href="dashboard.html">
                        <i class="bi bi-speedometer2"></i> Dashboard
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="manage-users.html">
                        <i class="bi bi-people"></i> Manage Users
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="manage-schools.html">
                        <i class="bi bi-building"></i> Manage Schools
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="assignments.html">
                        <i class="bi bi-person-check"></i> Assignments
                    </a>
                </li>
            </ul>
            
            <div class="sidebar-heading">
                Reports
            </div>
            
            <ul class="nav flex-column">
                <li class="nav-item">
                    <a class="nav-link" href="reports.html">
                        <i class="bi bi-file-earmark-text"></i> View Reports
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="evaluations.html">
                        <i class="bi bi-clipboard-check"></i> Evaluations
                    </a>
                </li>
            </ul>
            
            <div class="sidebar-heading">
                System
            </div>
            
            <ul class="nav flex-column">
                <li class="nav-item">
                    <a class="nav-link" href="settings.html">
                        <i class="bi bi-gear"></i> Settings
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" id="logoutBtn">
                        <i class="bi bi-box-arrow-right"></i> Logout
                    </a>
                </li>
            </ul>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <!-- Top Navigation -->
            <nav class="navbar navbar-expand-lg navbar-light top-navbar">
                <div class="container-fluid">
                    <button class="btn btn-sm btn-outline-secondary d-lg-none me-3" type="button" id="sidebarToggle" title="Toggle Sidebar">
                        <i class="bi bi-list"></i>
                    </button>
                    
                    <h4 class="mb-0">Manage Schools</h4>
                    
                    <div class="ms-auto d-flex align-items-center">
                        <div class="dropdown">
                            <a class="dropdown-toggle text-decoration-none text-dark d-flex align-items-center" href="#" role="button" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                <span class="me-2" id="userName">Admin User</span>
                                <div class="user-dropdown">
                                    <img src="../assets/images/avatar-placeholder.jpg" alt="User" id="userImage">
                                </div>
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                                <li><a class="dropdown-item" href="profile.html"><i class="bi bi-person me-2"></i> Profile</a></li>
                                <li><a class="dropdown-item" href="settings.html"><i class="bi bi-gear me-2"></i> Settings</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="#" id="logoutDropdownBtn"><i class="bi bi-box-arrow-right me-2"></i> Logout</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </nav>
            
            <!-- Alert Container -->
            <div id="alertContainer"></div>
            
            <!-- Content -->
            <div class="container-fluid">
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card shadow-sm">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h5 class="card-title mb-0">School Management</h5>
                                    <a href="add-school.html" class="btn btn-primary">
                                        <i class="bi bi-building-add"></i> Add New School
                                    </a>
                                </div>
                                
                                <!-- Filter Controls -->
                                <div class="row mb-4">
                                    <div class="col-md-4 mb-3">
                                        <label for="cityFilter" class="form-label">Filter by City</label>
                                        <select class="form-select" id="cityFilter">
                                            <option value="">All Cities</option>
                                            <!-- Cities will be populated dynamically -->
                                        </select>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label for="stateFilter" class="form-label">Filter by State</label>
                                        <select class="form-select" id="stateFilter">
                                            <option value="">All States</option>
                                            <!-- States will be populated dynamically -->
                                        </select>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label for="searchSchool" class="form-label">Search Schools</label>
                                        <input type="text" class="form-control" id="searchSchool" placeholder="Search by name...">
                                    </div>
                                </div>
                                
                                <!-- Schools Table -->
                                <div class="table-responsive">
                                    <table class="table table-hover data-table" id="schoolsTable">
                                        <thead>
                                            <tr>
                                                <th>Name</th>
                                                <th>Address</th>
                                                <th>City</th>
                                                <th>State</th>
                                                <th>Contact Person</th>
                                                <th>Contact Info</th>
                                                <th>Students</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- Dynamic content here -->
                                            <tr>
                                                <td colspan="8" class="text-center">Loading schools...</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                
                                <!-- Pagination -->
                                <nav aria-label="School pagination" class="mt-4">
                                    <ul class="pagination justify-content-center" id="schoolsPagination">
                                        <!-- Dynamic pagination -->
                                    </ul>
                                </nav>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- School Statistics -->
                <div class="row">
                    <div class="col-md-6 mb-4">
                        <div class="card shadow-sm h-100">
                            <div class="card-body">
                                <h5 class="card-title">Schools by State</h5>
                                <div class="chart-container chart-height">
                                    <canvas id="schoolsByStateChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-4">
                        <div class="card shadow-sm h-100">
                            <div class="card-body">
                                <h5 class="card-title">Student Distribution</h5>
                                <div class="chart-container chart-height">
                                    <canvas id="studentDistributionChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete School Confirmation Modal -->
    <div class="modal fade" id="deleteSchoolModal" tabindex="-1" aria-labelledby="deleteSchoolModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteSchoolModalLabel">Confirm Deletion</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete this school? This action cannot be undone.</p>
                    <p><strong>School:</strong> <span id="deleteSchoolName"></span></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete School</button>
                </div>
            </div>
        </div>
    </div>

    <!-- View School Modal -->
    <div class="modal fade" id="viewSchoolModal" tabindex="-1" aria-labelledby="viewSchoolModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="viewSchoolModalLabel">School Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="schoolDetailsContent">
                        <!-- School details will be loaded here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <a href="#" class="btn btn-primary" id="editSchoolBtn">Edit School</a>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <script src="../assets/js/main.js"></script>
    <script src="../assets/js/admin.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Load schools
            loadSchools();
            
            // Set up event listeners for filters
            document.getElementById('cityFilter').addEventListener('change', applyFilters);
            document.getElementById('stateFilter').addEventListener('change', applyFilters);
            document.getElementById('searchSchool').addEventListener('input', applyFilters);
            
            // Initialize delete modal functionality
            initDeleteModal();
            
            // Initialize charts
            initializeCharts();
        });
        
        /**
         * Load schools from API
         */
        function loadSchools() {
            const cityFilter = document.getElementById('cityFilter').value;
            const stateFilter = document.getElementById('stateFilter').value;
            const searchQuery = document.getElementById('searchSchool').value;
            
            let endpoint = '/admin/schools';
            const queryParams = [];
            
            if (cityFilter) {
                queryParams.push(`city=${encodeURIComponent(cityFilter)}`);
            }
            
            if (stateFilter) {
                queryParams.push(`state=${encodeURIComponent(stateFilter)}`);
            }
            
            if (searchQuery) {
                queryParams.push(`search=${encodeURIComponent(searchQuery)}`);
            }
            
            if (queryParams.length > 0) {
                endpoint += '?' + queryParams.join('&');
            }
            
            apiCall(endpoint)
                .then(data => {
                    const schools = data.schools || [];
                    updateSchoolsTable(schools);
                    
                    // Update filter dropdowns
                    updateFilterDropdowns(schools);
                    
                    // Update charts
                    updateCharts(schools);
                })
                .catch(error => {
                    console.error('Error loading schools:', error);
                    showAlert('Failed to load schools. Please try again later.', 'danger');
                    
                    // Show error in table
                    document.querySelector('#schoolsTable tbody').innerHTML = `
                        <tr>
                            <td colspan="8" class="text-center text-danger">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                Error loading schools. Please try again.
                            </td>
                        </tr>
                    `;
                });
        }
        
        /**
         * Update schools table with data
         */
        function updateSchoolsTable(schools) {
            const tableBody = document.querySelector('#schoolsTable tbody');
            
            if (!schools || schools.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center">No schools found matching your criteria.</td>
                    </tr>
                `;
                return;
            }
            
            let tableHtml = '';
            
            schools.forEach(school => {
                tableHtml += `
                    <tr>
                        <td>${school.name}</td>
                        <td>${school.address}</td>
                        <td>${school.city}</td>
                        <td>${school.state}</td>
                        <td>${school.contact_person || '-'}</td>
                        <td>
                            ${school.contact_email ? `<div><i class="bi bi-envelope me-1"></i>${school.contact_email}</div>` : ''}
                            ${school.contact_phone ? `<div><i class="bi bi-telephone me-1"></i>${school.contact_phone}</div>` : ''}
                            ${(!school.contact_email && !school.contact_phone) ? '-' : ''}
                        </td>
                        <td>
                            <span class="badge bg-primary">${school.assigned_students ? school.assigned_students.length : 0}</span>
                        </td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-sm btn-info view-school-btn" data-school-id="${school.id}">
                                    <i class="bi bi-eye"></i>
                                </button>
                                <a href="edit-school.html?id=${school.id}" class="btn btn-sm btn-primary">
                                    <i class="bi bi-pencil"></i>
                                </a>
                                <button class="btn btn-sm btn-danger delete-school-btn" data-school-id="${school.id}" data-school-name="${school.name}">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = tableHtml;
            
            // Attach event listeners to buttons
            attachSchoolButtonListeners();
        }
        
        /**
         * Attach event listeners to school table buttons
         */
        function attachSchoolButtonListeners() {
            // Delete buttons
            document.querySelectorAll('.delete-school-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const schoolId = this.getAttribute('data-school-id');
                    const schoolName = this.getAttribute('data-school-name');
                    
                    // Set up modal
                    document.getElementById('deleteSchoolName').textContent = schoolName;
                    
                    // Set up confirm button
                    const confirmBtn = document.getElementById('confirmDeleteBtn');
                    confirmBtn.setAttribute('data-school-id', schoolId);
                    
                    // Show modal
                    const deleteModal = new bootstrap.Modal(document.getElementById('deleteSchoolModal'));
                    deleteModal.show();
                });
            });
            
            // View buttons
            document.querySelectorAll('.view-school-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const schoolId = this.getAttribute('data-school-id');
                    viewSchoolDetails(schoolId);
                });
            });
        }
        
        /**
         * View school details in modal
         */
        function viewSchoolDetails(schoolId) {
            apiCall(`/admin/schools/${schoolId}`)
                .then(data => {
                    const school = data.school;
                    
                    // Set edit button URL
                    document.getElementById('editSchoolBtn').href = `edit-school.html?id=${school.id}`;
                    
                    // Fill modal content
                    const contentDiv = document.getElementById('schoolDetailsContent');
                    contentDiv.innerHTML = `
                        <div class="row">
                            <div class="col-md-6">
                                <h5>${school.name}</h5>
                                <p>
                                    <i class="bi bi-geo-alt me-2"></i>
                                    ${school.address}, ${school.city}, ${school.state}
                                </p>
                            </div>
                            <div class="col-md-6">
                                <h6>Contact Information</h6>
                                <p>
                                    ${school.contact_person ? `<div><strong>Contact Person:</strong> ${school.contact_person}</div>` : ''}
                                    ${school.contact_email ? `<div><strong>Email:</strong> ${school.contact_email}</div>` : ''}
                                    ${school.contact_phone ? `<div><strong>Phone:</strong> ${school.contact_phone}</div>` : ''}
                                    ${(!school.contact_person && !school.contact_email && !school.contact_phone) ? 'No contact information available.' : ''}
                                </p>
                            </div>
                        </div>
                        
                        <div class="row mt-4">
                            <div class="col-12">
                                <h6>Assigned Students</h6>
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Name</th>
                                                <th>Email</th>
                                                <th>Supervisor</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${school.assigned_students && school.assigned_students.length > 0 ? 
                                                school.assigned_students.map(student => `
                                                    <tr>
                                                        <td>${student.first_name} ${student.last_name}</td>
                                                        <td>${student.email}</td>
                                                        <td>${student.supervisor ? `${student.supervisor.first_name} ${student.supervisor.last_name}` : 'Not assigned'}</td>
                                                    </tr>
                                                `).join('') : 
                                                '<tr><td colspan="3" class="text-center">No students assigned to this school yet.</td></tr>'
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // Show modal
                    const viewModal = new bootstrap.Modal(document.getElementById('viewSchoolModal'));
                    viewModal.show();
                })
                .catch(error => {
                    console.error('Error loading school details:', error);
                    showAlert('Failed to load school details. Please try again later.', 'danger');
                });
        }
        
        /**
         * Update filter dropdowns with unique values
         */
        function updateFilterDropdowns(schools) {
            // Get unique cities
            const cities = [...new Set(schools.map(school => school.city))].sort();
            const citySelect = document.getElementById('cityFilter');
            const currentCityValue = citySelect.value;
            
            // Clear options except the first
            const firstCityOption = citySelect.querySelector('option:first-child');
            citySelect.innerHTML = '';
            citySelect.appendChild(firstCityOption);
            
            // Add city options
            cities.forEach(city => {
                const option = document.createElement('option');
                option.value = city;
                option.textContent = city;
                citySelect.appendChild(option);
            });
            
            // Restore selected value if possible
            if (currentCityValue && cities.includes(currentCityValue)) {
                citySelect.value = currentCityValue;
            }
            
            // Get unique states
            const states = [...new Set(schools.map(school => school.state))].sort();
            const stateSelect = document.getElementById('stateFilter');
            const currentStateValue = stateSelect.value;
            
            // Clear options except the first
            const firstStateOption = stateSelect.querySelector('option:first-child');
            stateSelect.innerHTML = '';
            stateSelect.appendChild(firstStateOption);
            
            // Add state options
            states.forEach(state => {
                const option = document.createElement('option');
                option.value = state;
                option.textContent = state;
                stateSelect.appendChild(option);
            });
            
            // Restore selected value if possible
            if (currentStateValue && states.includes(currentStateValue)) {
                stateSelect.value = currentStateValue;
            }
        }
        
        /**
         * Initialize charts
         */
        function initializeCharts() {
            // Schools by State chart
            const stateCtx = document.getElementById('schoolsByStateChart').getContext('2d');
            window.schoolsByStateChart = new Chart(stateCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Number of Schools',
                        data: [],
                        backgroundColor: 'rgba(52, 152, 219, 0.7)',
                        borderColor: 'rgba(52, 152, 219, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    }
                }
            });
            
            // Student Distribution chart
            const distributionCtx = document.getElementById('studentDistributionChart').getContext('2d');
            window.studentDistributionChart = new Chart(distributionCtx, {
                type: 'pie',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: [
                            'rgba(52, 152, 219, 0.7)',
                            'rgba(46, 204, 113, 0.7)',
                            'rgba(231, 76, 60, 0.7)',
                            'rgba(241, 196, 15, 0.7)',
                            'rgba(155, 89, 182, 0.7)'
                        ],
                        borderColor: [
                            'rgba(52, 152, 219, 1)',
                            'rgba(46, 204, 113, 1)',
                            'rgba(231, 76, 60, 1)',
                            'rgba(241, 196, 15, 1)',
                            'rgba(155, 89, 182, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right'
                        }
                    }
                }
            });
        }
        
        /**
         * Update charts with school data
         */
        function updateCharts(schools) {
            // Update Schools by State chart
            const stateCount = {};
            schools.forEach(school => {
                stateCount[school.state] = (stateCount[school.state] || 0) + 1;
            });
            
            const stateLabels = Object.keys(stateCount);
            const stateCounts = stateLabels.map(state => stateCount[state]);
            
            window.schoolsByStateChart.data.labels = stateLabels;
            window.schoolsByStateChart.data.datasets[0].data = stateCounts;
            window.schoolsByStateChart.update();
            
            // Update Student Distribution chart
            // First, identify top schools by student count and group the rest
            const schoolStudentCounts = schools.map(school => ({
                name: school.name,
                count: school.assigned_students ? school.assigned_students.length : 0
            })).sort((a, b) => b.count - a.count);
            
            // Take top 4 schools and group the rest
            const topSchools = schoolStudentCounts.slice(0, 4);
            const otherSchools = schoolStudentCounts.slice(4);
            
            const otherCount = otherSchools.reduce((sum, school) => sum + school.count, 0);
            
            const distributionLabels = topSchools.map(school => school.name);
            const distributionData = topSchools.map(school => school.count);
            
            // Add "Other" category if there are more than 4 schools
            if (otherSchools.length > 0) {
                distributionLabels.push('Other Schools');
                distributionData.push(otherCount);
            }
            
            window.studentDistributionChart.data.labels = distributionLabels;
            window.studentDistributionChart.data.datasets[0].data = distributionData;
            window.studentDistributionChart.update();
        }
        
        /**
         * Initialize delete modal functionality
         */
        function initDeleteModal() {
            const confirmBtn = document.getElementById('confirmDeleteBtn');
            
            confirmBtn.addEventListener('click', function() {
                const schoolId = this.getAttribute('data-school-id');
                
                // Call API to delete school
                apiCall(`/admin/schools/${schoolId}`, 'DELETE')
                    .then(response => {
                        // Hide modal
                        bootstrap.Modal.getInstance(document.getElementById('deleteSchoolModal')).hide();
                        
                        // Show success message
                        showAlert('School deleted successfully.', 'success');
                        
                        // Reload schools
                        setTimeout(() => {
                            loadSchools();
                        }, 1000);
                    })
                    .catch(error => {
                        console.error('Error deleting school:', error);
                        
                        // Check if there's a message about students assigned
                        if (error.message && error.message.includes('students')) {
                            showAlert('Cannot delete school with assigned students. Please reassign students first.', 'danger');
                        } else {
                            showAlert('Failed to delete school. Please try again later.', 'danger');
                        }
                    });
            });
        }
        
        /**
         * Apply filters to schools list
         */
        function applyFilters() {
            loadSchools();
        }
    </script>
</body>
</html>