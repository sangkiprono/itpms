<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assignments - Teaching Practice Management System</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="../assets/css/style.css">
</head>
<body>
    <div class="d-flex">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="navbar-brand d-flex align-items-center justify-content-center">
                <i class="bi bi-book me-2"></i>
                <span>TPMS Admin</span>
            </div>
            
            <div class="sidebar-heading">
                Main
            </div>
            
            <ul class="nav flex-column">
                <li class="nav-item">
                    <a class="nav-link" href="dashboard.html">
                        <i class="bi bi-speedometer2"></i> Dashboard
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="manage-users.html">
                        <i class="bi bi-people"></i> Manage Users
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="manage-schools.html">
                        <i class="bi bi-building"></i> Manage Schools
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="assignments.html">
                        <i class="bi bi-person-check"></i> Assignments
                    </a>
                </li>
            </ul>
            
            <div class="sidebar-heading">
                Reports
            </div>
            
            <ul class="nav flex-column">
                <li class="nav-item">
                    <a class="nav-link" href="reports.html">
                        <i class="bi bi-file-earmark-text"></i> View Reports
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="evaluations.html">
                        <i class="bi bi-clipboard-check"></i> Evaluations
                    </a>
                </li>
            </ul>
            
            <div class="sidebar-heading">
                System
            </div>
            
            <ul class="nav flex-column">
                <li class="nav-item">
                    <a class="nav-link" href="settings.html">
                        <i class="bi bi-gear"></i> Settings
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" id="logoutBtn">
                        <i class="bi bi-box-arrow-right"></i> Logout
                    </a>
                </li>
            </ul>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <!-- Top Navigation -->
            <nav class="navbar navbar-expand-lg navbar-light top-navbar">
                <div class="container-fluid">
                    <button class="btn btn-sm btn-outline-secondary d-lg-none me-3" type="button" id="sidebarToggle" title="Toggle Sidebar">
                        <i class="bi bi-list"></i>
                    </button>
                    
                    <h4 class="mb-0">Student Assignments</h4>
                    
                    <div class="ms-auto d-flex align-items-center">
                        <div class="dropdown">
                            <a class="dropdown-toggle text-decoration-none text-dark d-flex align-items-center" href="#" role="button" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                <span class="me-2" id="userName">Admin User</span>
                                <div class="user-dropdown">
                                    <img src="../assets/images/avatar-placeholder.jpg" alt="User" id="userImage">
                                </div>
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                                <li><a class="dropdown-item" href="profile.html"><i class="bi bi-person me-2"></i> Profile</a></li>
                                <li><a class="dropdown-item" href="settings.html"><i class="bi bi-gear me-2"></i> Settings</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="#" id="logoutDropdownBtn"><i class="bi bi-box-arrow-right me-2"></i> Logout</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </nav>
            
            <!-- Alert Container -->
            <div id="alertContainer"></div>
            
            <!-- Content -->
            <div class="container-fluid">
                <!-- Assignment Forms -->
                <div class="row mb-4">
                    <div class="col-md-6 mb-4">
                        <div class="card shadow-sm h-100">
                            <div class="card-body">
                                <h5 class="card-title mb-4">Assign Student to School</h5>
                                
                                <form id="schoolAssignmentForm" data-assignment-type="school">
                                    <div class="mb-3">
                                        <label for="studentSelect" class="form-label">Select Student <span class="text-danger">*</span></label>
                                        <select class="form-select" id="studentSelect" name="student_id" required>
                                            <option value="" selected disabled>Select a student</option>
                                            <!-- Students will be loaded dynamically -->
                                        </select>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="schoolSelect" class="form-label">Select School <span class="text-danger">*</span></label>
                                        <select class="form-select" id="schoolSelect" name="school_id" required>
                                            <option value="" selected disabled>Select a school</option>
                                            <!-- Schools will be loaded dynamically -->
                                        </select>
                                    </div>
                                    
                                    <div class="text-end">
                                        <button type="submit" class="btn btn-primary">
                                            <i class="bi bi-building-add me-1"></i> Assign to School
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6 mb-4">
                        <div class="card shadow-sm h-100">
                            <div class="card-body">
                                <h5 class="card-title mb-4">Assign Student to Lecturer</h5>
                                
                                <form id="lecturerAssignmentForm" data-assignment-type="lecturer">
                                    <div class="mb-3">
                                        <label for="studentSelect2" class="form-label">Select Student <span class="text-danger">*</span></label>
                                        <select class="form-select" id="studentSelect2" name="student_id" required>
                                            <option value="" selected disabled>Select a student</option>
                                            <!-- Students will be loaded dynamically -->
                                        </select>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="lecturerSelect" class="form-label">Select Lecturer <span class="text-danger">*</span></label>
                                        <select class="form-select" id="lecturerSelect" name="lecturer_id" required>
                                            <option value="" selected disabled>Select a lecturer</option>
                                            <!-- Lecturers will be loaded dynamically -->
                                        </select>
                                    </div>
                                    
                                    <div class="text-end">
                                        <button type="submit" class="btn btn-primary">
                                            <i class="bi bi-person-add me-1"></i> Assign to Lecturer
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Current Assignments Table -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card shadow-sm">
                            <div class="card-body">
                                <h5 class="card-title mb-4">Current Assignments</h5>
                                
                                <!-- Filter and Search Controls -->
                                <div class="row mb-4">
                                    <div class="col-md-4 mb-3">
                                        <input type="text" class="form-control" id="searchAssignments" placeholder="Search by name...">
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <select class="form-select" id="schoolFilter" title="Filter by school">
                                            <option value="">All Schools</option>
                                            <!-- Schools will be loaded dynamically -->
                                        </select>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <select class="form-select" id="lecturerFilter" title="Filter by lecturer">
                                            <option value="">All Lecturers</option>
                                            <!-- Lecturers will be loaded dynamically -->
                                        </select>
                                    </div>
                                </div>
                                
                                <!-- Assignments Table -->
                                <div class="table-responsive">
                                    <table class="table table-hover" id="assignmentsTable">
                                        <thead>
                                            <tr>
                                                <th>Student</th>
                                                <th>School</th>
                                                <th>Lecturer</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- Assignments will be loaded dynamically -->
                                            <tr>
                                                <td colspan="4" class="text-center">Loading assignments...</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Assignment Statistics -->
                <div class="row">
                    <div class="col-md-6 mb-4">
                        <div class="card shadow-sm h-100">
                            <div class="card-body">
                                <h5 class="card-title">Student Assignment Status</h5>
                                <div class="chart-container chart-style">
                                    <canvas id="assignmentStatusChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-4">
                        <div class="card shadow-sm h-100">
                            <div class="card-body">
                                <h5 class="card-title">Lecturer Workload</h5>
                                <div class="chart-container chart-style">
                                    <canvas id="lecturerWorkloadChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Remove Assignment Confirmation Modal -->
    <div class="modal fade" id="removeAssignmentModal" tabindex="-1" aria-labelledby="removeAssignmentModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="removeAssignmentModalLabel">Confirm Removal</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to remove this assignment?</p>
                    <p id="assignmentDetails"></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmRemoveBtn">Remove Assignment</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <script src="../assets/js/main.js"></script>
    <script src="../assets/js/admin.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Load students, schools, and lecturers for select dropdowns
            loadStudentsForSelect('studentSelect');
            loadStudentsForSelect('studentSelect2');
            loadSchoolsForSelect('schoolSelect');
            loadLecturersForSelect('lecturerSelect');
            
            // Load filter options
            loadFilterOptions();
            
            // Load current assignments
            loadAssignments();
            
            // Initialize charts
            initializeCharts();
            
            // Set up event listeners for forms
            document.getElementById('schoolAssignmentForm').addEventListener('submit', handleSchoolAssignment);
            document.getElementById('lecturerAssignmentForm').addEventListener('submit', handleLecturerAssignment);
            
            // Set up event listeners for filters
            document.getElementById('searchAssignments').addEventListener('input', filterAssignments);
            document.getElementById('schoolFilter').addEventListener('change', filterAssignments);
            document.getElementById('lecturerFilter').addEventListener('change', filterAssignments);
        });
        
        /**
         * Load students for dropdown select
         * @param {string} selectId - ID of the select element to populate
         */
        function loadStudentsForSelect(selectId) {
            apiCall('/admin/users?role=student')
                .then(data => {
                    const students = data.users || [];
                    const selectElement = document.getElementById(selectId);
                    
                    if (!selectElement) return;
                    
                    // Clear options except the first
                    const firstOption = selectElement.querySelector('option:first-child');
                    selectElement.innerHTML = '';
                    selectElement.appendChild(firstOption);
                    
                    // Add student options
                    students.filter(student => student.is_active).forEach(student => {
                        const option = document.createElement('option');
                        option.value = student.id;
                        option.textContent = `${student.first_name} ${student.last_name}`;
                        selectElement.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Error loading students:', error);
                    showAlert('Failed to load students. Please try again later.', 'danger');
                });
        }
        
        /**
         * Load schools for dropdown select
         * @param {string} selectId - ID of the select element to populate
         */
        function loadSchoolsForSelect(selectId) {
            apiCall('/admin/schools')
                .then(data => {
                    const schools = data.schools || [];
                    const selectElement = document.getElementById(selectId);
                    
                    if (!selectElement) return;
                    
                    // Clear options except the first
                    const firstOption = selectElement.querySelector('option:first-child');
                    selectElement.innerHTML = '';
                    selectElement.appendChild(firstOption);
                    
                    // Add school options
                    schools.forEach(school => {
                        const option = document.createElement('option');
                        option.value = school.id;
                        option.textContent = school.name;
                        selectElement.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Error loading schools:', error);
                    showAlert('Failed to load schools. Please try again later.', 'danger');
                });
        }
        
        /**
         * Load lecturers for dropdown select
         * @param {string} selectId - ID of the select element to populate
         */
        function loadLecturersForSelect(selectId) {
            apiCall('/admin/users?role=lecturer')
                .then(data => {
                    const lecturers = data.users || [];
                    const selectElement = document.getElementById(selectId);
                    
                    if (!selectElement) return;
                    
                    // Clear options except the first
                    const firstOption = selectElement.querySelector('option:first-child');
                    selectElement.innerHTML = '';
                    selectElement.appendChild(firstOption);
                    
                    // Add lecturer options
                    lecturers.filter(lecturer => lecturer.is_active).forEach(lecturer => {
                        const option = document.createElement('option');
                        option.value = lecturer.id;
                        option.textContent = `${lecturer.first_name} ${lecturer.last_name}`;
                        selectElement.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Error loading lecturers:', error);
                    showAlert('Failed to load lecturers. Please try again later.', 'danger');
                });
        }
        
        /**
         * Load filter options for schools and lecturers
         */
        function loadFilterOptions() {
            // Schools for filter
            apiCall('/admin/schools')
                .then(data => {
                    const schools = data.schools || [];
                    const selectElement = document.getElementById('schoolFilter');
                    
                    if (!selectElement) return;
                    
                    // Clear options except the first
                    const firstOption = selectElement.querySelector('option:first-child');
                    selectElement.innerHTML = '';
                    selectElement.appendChild(firstOption);
                    
                    // Add school options
                    schools.forEach(school => {
                        const option = document.createElement('option');
                        option.value = school.id;
                        option.textContent = school.name;
                        selectElement.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Error loading school filters:', error);
                });
            
            // Lecturers for filter
            apiCall('/admin/users?role=lecturer')
                .then(data => {
                    const lecturers = data.users || [];
                    const selectElement = document.getElementById('lecturerFilter');
                    
                    if (!selectElement) return;
                    
                    // Clear options except the first
                    const firstOption = selectElement.querySelector('option:first-child');
                    selectElement.innerHTML = '';
                    selectElement.appendChild(firstOption);
                    
                    // Add lecturer options
                    lecturers.filter(lecturer => lecturer.is_active).forEach(lecturer => {
                        const option = document.createElement('option');
                        option.value = lecturer.id;
                        option.textContent = `${lecturer.first_name} ${lecturer.last_name}`;
                        selectElement.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Error loading lecturer filters:', error);
                });
        }
        
        /**
         * Load current assignments
         */
        function loadAssignments() {
            // For this demo, we'll create simulated data since we don't have a single endpoint for all assignments
            // In a real application, you would have an API endpoint for this
            Promise.all([
                apiCall('/admin/users?role=student'),
                apiCall('/admin/schools')
            ])
                .then(([studentsData, schoolsData]) => {
                    const students = studentsData.users || [];
                    const schools = schoolsData.schools || [];
                    
                    // Simulate assignments by joining student and school data
                    const assignments = students.map(student => {
                        const assignedSchools = student.assigned_schools || [];
                        const assignedLecturers = student.supervisors || [];
                        
                        return {
                            student: student,
                            schools: assignedSchools.map(schoolId => {
                                return schools.find(s => s.id === schoolId) || { name: 'Unknown School' };
                            }),
                            lecturers: assignedLecturers.map(lecturerId => {
                                return students.find(l => l.id === lecturerId && l.role === 'lecturer') || { first_name: 'Unknown', last_name: 'Lecturer' };
                            })
                        };
                    });
                    
                    updateAssignmentsTable(assignments);
                    updateAssignmentCharts(assignments);
                })
                .catch(error => {
                    console.error('Error loading assignments:', error);
                    document.querySelector('#assignmentsTable tbody').innerHTML = `
                        <tr>
                            <td colspan="4" class="text-center text-danger">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                Error loading assignments. Please try again.
                            </td>
                        </tr>
                    `;
                });
        }
        
        /**
         * Update assignments table with data
         */
        function updateAssignmentsTable(assignments) {
            const tableBody = document.querySelector('#assignmentsTable tbody');
            
            if (!assignments || assignments.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="4" class="text-center">No assignments found.</td>
                    </tr>
                `;
                return;
            }
            
            // Filter assignments if needed
            const searchText = document.getElementById('searchAssignments').value.toLowerCase();
            const schoolFilter = document.getElementById('schoolFilter').value;
            const lecturerFilter = document.getElementById('lecturerFilter').value;
            
            let filteredAssignments = assignments;
            
            if (searchText) {
                filteredAssignments = filteredAssignments.filter(assignment => {
                    const studentName = `${assignment.student.first_name} ${assignment.student.last_name}`.toLowerCase();
                    return studentName.includes(searchText);
                });
            }
            
            if (schoolFilter) {
                filteredAssignments = filteredAssignments.filter(assignment => {
                    return assignment.schools.some(school => school.id === schoolFilter);
                });
            }
            
            if (lecturerFilter) {
                filteredAssignments = filteredAssignments.filter(assignment => {
                    return assignment.lecturers.some(lecturer => lecturer.id === lecturerFilter);
                });
            }
            
            if (filteredAssignments.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="4" class="text-center">No assignments match your filters.</td>
                    </tr>
                `;
                return;
            }
            
            let tableHtml = '';
            
            filteredAssignments.forEach(assignment => {
                const studentName = `${assignment.student.first_name} ${assignment.student.last_name}`;
                const schools = assignment.schools.map(school => school.name).join(', ') || 'Not assigned';
                const lecturers = assignment.lecturers.map(lecturer => `${lecturer.first_name} ${lecturer.last_name}`).join(', ') || 'Not assigned';
                
                tableHtml += `
                    <tr>
                        <td>${studentName}</td>
                        <td>${schools}</td>
                        <td>${lecturers}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-sm btn-danger remove-school-btn" data-student-id="${assignment.student.id}" data-student-name="${studentName}">
                                    <i class="bi bi-trash"></i> Remove
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = tableHtml;
            
            // Attach event listeners to remove buttons
            document.querySelectorAll('.remove-school-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const studentId = this.getAttribute('data-student-id');
                    const studentName = this.getAttribute('data-student-name');
                    
                    showRemoveAssignmentModal(studentId, studentName);
                });
            });
        }
        
        /**
         * Show modal to confirm assignment removal
         */
        function showRemoveAssignmentModal(studentId, studentName) {
            const detailsElement = document.getElementById('assignmentDetails');
            detailsElement.innerHTML = `<strong>Student:</strong> ${studentName}`;
            
            const confirmBtn = document.getElementById('confirmRemoveBtn');
            confirmBtn.setAttribute('data-student-id', studentId);
            
            const modal = new bootstrap.Modal(document.getElementById('removeAssignmentModal'));
            modal.show();
            
            confirmBtn.onclick = function() {
                // In a real application, you would make API calls to remove assignments
                // For this demo, we'll just show a success message
                modal.hide();
                showAlert('Assignment removed successfully.', 'success');
                
                // Reload assignments
                setTimeout(() => {
                    loadAssignments();
                }, 1000);
            };
        }
        
        /**
         * Handle school assignment form submission
         */
        function handleSchoolAssignment(e) {
            e.preventDefault();
            
            const studentId = document.getElementById('studentSelect').value;
            const schoolId = document.getElementById('schoolSelect').value;
            
            if (!studentId || !schoolId) {
                showAlert('Please select both a student and a school.', 'warning');
                return;
            }
            
            const data = {
                student_id: studentId,
                school_id: schoolId
            };
            
            apiCall('/admin/assign-school', 'POST', data)
                .then(response => {
                    showAlert('Student assigned to school successfully.', 'success');
                    
                    // Reset form
                    document.getElementById('schoolAssignmentForm').reset();
                    
                    // Reload assignments
                    setTimeout(() => {
                        loadAssignments();
                    }, 1000);
                })
                .catch(error => {
                    console.error('Error assigning student to school:', error);
                    showAlert('Failed to assign student to school. ' + (error.message || 'Please try again later.'), 'danger');
                });
        }
        
        /**
         * Handle lecturer assignment form submission
         */
        function handleLecturerAssignment(e) {
            e.preventDefault();
            
            const studentId = document.getElementById('studentSelect2').value;
            const lecturerId = document.getElementById('lecturerSelect').value;
            
            if (!studentId || !lecturerId) {
                showAlert('Please select both a student and a lecturer.', 'warning');
                return;
            }
            
            const data = {
                student_id: studentId,
                lecturer_id: lecturerId
            };
            
            apiCall('/admin/assign-lecturer', 'POST', data)
                .then(response => {
                    showAlert('Student assigned to lecturer successfully.', 'success');
                    
                    // Reset form
                    document.getElementById('lecturerAssignmentForm').reset();
                    
                    // Reload assignments
                    setTimeout(() => {
                        loadAssignments();
                    }, 1000);
                })
                .catch(error => {
                    console.error('Error assigning student to lecturer:', error);
                    showAlert('Failed to assign student to lecturer. ' + (error.message || 'Please try again later.'), 'danger');
                });
        }
        
        /**
         * Filter assignments based on search and filters
         */
        function filterAssignments() {
            loadAssignments();
        }
        
        /**
         * Initialize charts
         */
        function initializeCharts() {
            // Assignment Status Chart
            const statusCtx = document.getElementById('assignmentStatusChart').getContext('2d');
            window.assignmentStatusChart = new Chart(statusCtx, {
                type: 'pie',
                data: {
                    labels: ['Fully Assigned', 'School Only', 'Lecturer Only', 'No Assignments'],
                    datasets: [{
                        data: [0, 0, 0, 0],
                        backgroundColor: [
                            'rgba(46, 204, 113, 0.7)',
                            'rgba(52, 152, 219, 0.7)',
                            'rgba(155, 89, 182, 0.7)',
                            'rgba(231, 76, 60, 0.7)'
                        ],
                        borderColor: [
                            'rgba(46, 204, 113, 1)',
                            'rgba(52, 152, 219, 1)',
                            'rgba(155, 89, 182, 1)',
                            'rgba(231, 76, 60, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right'
                        }
                    }
                }
            });
            
            // Lecturer Workload Chart
            const workloadCtx = document.getElementById('lecturerWorkloadChart').getContext('2d');
            window.lecturerWorkloadChart = new Chart(workloadCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Assigned Students',
                        data: [],
                        backgroundColor: 'rgba(52, 152, 219, 0.7)',
                        borderColor: 'rgba(52, 152, 219, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    }
                }
            });
        }
        
        /**
         * Update assignment charts with data
         */
        function updateAssignmentCharts(assignments) {
            // Update Assignment Status Chart
            let fullyAssigned = 0;
            let schoolOnly = 0;
            let lecturerOnly = 0;
            let noAssignments = 0;
            
            assignments.forEach(assignment => {
                const hasSchool = assignment.schools.length > 0;
                const hasLecturer = assignment.lecturers.length > 0;
                
                if (hasSchool && hasLecturer) {
                    fullyAssigned++;
                } else if (hasSchool) {
                    schoolOnly++;
                } else if (hasLecturer) {
                    lecturerOnly++;
                } else {
                    noAssignments++;
                }
            });
            
            window.assignmentStatusChart.data.datasets[0].data = [
                fullyAssigned,
                schoolOnly,
                lecturerOnly,
                noAssignments
            ];
            window.assignmentStatusChart.update();
            
            // Update Lecturer Workload Chart
            const lecturerWorkload = {};
            
            // Gather all lecturers and their assigned students
            assignments.forEach(assignment => {
                assignment.lecturers.forEach(lecturer => {
                    const lecturerName = `${lecturer.first_name} ${lecturer.last_name}`;
                    lecturerWorkload[lecturerName] = (lecturerWorkload[lecturerName] || 0) + 1;
                });
            });
            
            // Sort lecturers by workload (descending)
            const sortedLecturers = Object.entries(lecturerWorkload)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5); // Show top 5 lecturers
            
            const lecturerLabels = sortedLecturers.map(entry => entry[0]);
            const lecturerData = sortedLecturers.map(entry => entry[1]);
            
            window.lecturerWorkloadChart.data.labels = lecturerLabels;
            window.lecturerWorkloadChart.data.datasets[0].data = lecturerData;
            window.lecturerWorkloadChart.update();
        }
    </script>
</body>
</html>